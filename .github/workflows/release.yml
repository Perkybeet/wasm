name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write
  packages: write

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest
    outputs:
      upload_url: ${{ steps.create_release.outputs.upload_url }}
      version: ${{ steps.get_version.outputs.version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get version from tag
        id: get_version
        run: echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Extract changelog
        id: changelog
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          # Extract changelog for this version from obs/debian.changelog
          CHANGELOG=$(sed -n "/^wasm (${VERSION}/,/^wasm (/p" obs/debian.changelog | head -n -1 | tail -n +2 | sed 's/^  //')
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: WASM v${{ steps.get_version.outputs.version }}
          body: |
            ## Changes in v${{ steps.get_version.outputs.version }}
            
            ${{ steps.changelog.outputs.changelog }}
            
            ## Installation
            
            ### Ubuntu/Debian
            ```bash
            curl -fsSL https://download.opensuse.org/repositories/home:Perkybeet/xUbuntu_24.04/Release.key | sudo gpg --dearmor -o /usr/share/keyrings/wasm.gpg
            echo "deb [signed-by=/usr/share/keyrings/wasm.gpg] https://download.opensuse.org/repositories/home:Perkybeet/xUbuntu_24.04/ /" | sudo tee /etc/apt/sources.list.d/wasm.list
            sudo apt update && sudo apt install wasm
            ```
            
            ### Fedora
            ```bash
            sudo dnf config-manager addrepo --from-repofile=https://download.opensuse.org/repositories/home:Perkybeet/Fedora_42/home:Perkybeet.repo
            sudo dnf install wasm-cli
            ```
            
            ### From PyPI
            ```bash
            pip install wasm-cli
            ```
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-sdist:
    name: Build Source Distribution
    runs-on: ubuntu-latest
    needs: release
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install build tools
        run: pip install build

      - name: Build sdist and wheel
        run: python -m build

      - name: Upload to Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          files: |
            dist/*.tar.gz
            dist/*.whl
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-deb:
    name: Build Debian Package
    runs-on: ubuntu-latest
    needs: release
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential debhelper dh-python python3-all python3-setuptools python3-pip python3-wheel

      - name: Prepare Debian directory
        run: |
          mkdir -p debian
          cp obs/debian.changelog debian/changelog
          cp obs/debian.control debian/control
          cp obs/debian.copyright debian/copyright
          cp obs/debian.rules debian/rules
          cp obs/debian.postinst debian/postinst
          cp obs/debian.postrm debian/postrm
          cp obs/wasm.default.yaml debian/wasm.default.yaml
          cp obs/wasm.dirs debian/dirs
          cp obs/wasm.manpages debian/manpages
          cp obs/wasm.1 debian/wasm.1
          chmod +x debian/rules

      - name: Build Debian package
        run: dpkg-buildpackage -us -uc -b

      - name: Upload to Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          files: ../wasm_*.deb
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  publish-pypi:
    name: Publish to PyPI
    runs-on: ubuntu-latest
    needs: build-sdist
    environment:
      name: pypi
      url: https://pypi.org/p/wasm-cli
    permissions:
      id-token: write  # Required for trusted publishing
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install build tools
        run: pip install build

      - name: Build package
        run: python -m build

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1

  publish-obs:
    name: Publish to OBS
    runs-on: ubuntu-latest
    needs: release
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for git archive

      - name: Install osc
        run: |
          sudo apt-get update
          sudo apt-get install -y osc

      - name: Configure osc
        env:
          OBS_USER: ${{ secrets.OBS_USER }}
          OBS_PASS: ${{ secrets.OBS_PASS }}
        run: |
          # Create config in both locations for compatibility
          mkdir -p ~/.config/osc
          
          # Write config
          cat > ~/.oscrc << OSCEOF
          [general]
          apiurl = https://api.opensuse.org

          [https://api.opensuse.org]
          user = ${OBS_USER}
          pass = ${OBS_PASS}
          trusted_prj = openSUSE:Factory openSUSE:Tumbleweed
          OSCEOF
          
          # Remove leading spaces from heredoc
          sed -i 's/^          //' ~/.oscrc
          chmod 600 ~/.oscrc
          
          # Symlink to config dir
          ln -sf ~/.oscrc ~/.config/osc/oscrc
          
          # Debug: show config (without password)
          echo "=== OSC Config (sanitized) ==="
          grep -v "^pass" ~/.oscrc
          echo "pass = ********"
          echo "=== Testing OSC connection ==="
          osc api /about || echo "Connection test failed"

      - name: Get version
        id: version
        run: |
          VERSION=$(head -n 1 obs/debian.changelog | grep -oP '\(\K[^)]+' | cut -d'~' -f1)
          VERSION_BASE=$(echo "${VERSION}" | cut -d'-' -f1)
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "version_base=${VERSION_BASE}" >> $GITHUB_OUTPUT

      - name: Create source tarball
        run: |
          VERSION_BASE="${{ steps.version.outputs.version_base }}"
          git archive --format=tar.gz --prefix=wasm-${VERSION_BASE}/ HEAD ':!debian' > wasm-${VERSION_BASE}.tar.gz

      - name: Upload to OBS
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          VERSION_BASE="${{ steps.version.outputs.version_base }}"
          TARBALL="wasm-${VERSION_BASE}.tar.gz"
          
          # Checkout OBS package
          osc checkout home:Perkybeet/wasm
          cd home:Perkybeet/wasm
          
          # Remove old tarballs
          for old in wasm-*.tar.gz; do
            [ -f "$old" ] && [ "$old" != "${TARBALL}" ] && osc rm "$old" 2>/dev/null || true
          done
          
          # Copy new files
          cp ../../${TARBALL} .
          cp ../../rpm/wasm.spec .
          cp ../../obs/wasm.dsc .
          cp ../../obs/debian.control .
          cp ../../obs/debian.rules .
          cp ../../obs/debian.changelog .
          cp ../../obs/debian.copyright .
          cp ../../obs/debian.postinst . 2>/dev/null || true
          cp ../../obs/debian.postrm . 2>/dev/null || true
          cp ../../obs/wasm.default.yaml . 2>/dev/null || true
          cp ../../obs/wasm.1 . 2>/dev/null || true
          cp ../../obs/wasm.dirs . 2>/dev/null || true
          cp ../../obs/wasm.manpages . 2>/dev/null || true
          
          # Add new files
          osc add ${TARBALL} 2>/dev/null || true
          osc add wasm.spec 2>/dev/null || true
          osc add wasm.dsc 2>/dev/null || true
          osc add debian.* 2>/dev/null || true
          osc add wasm.default.yaml 2>/dev/null || true
          osc add wasm.1 2>/dev/null || true
          
          # Show status and commit
          osc status
          osc commit -m "Release v${VERSION_BASE} from GitHub Actions"
          
          echo "âœ… Package uploaded to OBS successfully!"
          echo "View at: https://build.opensuse.org/package/show/home:Perkybeet/wasm"
